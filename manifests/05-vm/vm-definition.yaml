apiVersion: kubevirt.io/v1
kind: VirtualMachine
metadata:
  name: legacy-validator
  namespace: inventory-demo
  labels:
    app: legacy-validator
    component: vm
    version: v1
    # Service mesh labels
    service.istio.io/canonical-name: legacy-validator
    service.istio.io/canonical-revision: v1
  annotations:
    argocd.argoproj.io/sync-wave: "1"
    description: "Legacy RHEL8 VM running item validation service"
spec:
  # VM should be running
  running: true
  
  # VM Template
  template:
    metadata:
      labels:
        app: legacy-validator
        component: vm
        version: v1
        # Important: These labels help with service mesh integration
        kubevirt.io/vm: legacy-validator
        service.istio.io/canonical-name: legacy-validator
        service.istio.io/canonical-revision: v1
      annotations:
        # Note: VMs don't get Istio sidecar injection automatically
        # We'll handle service mesh integration via WorkloadEntry
        vm.kubevirt.io/os: "fedora34"
    spec:
      # VM should be scheduled and restart if it fails
      domain:
        # CPU and Memory configuration
        cpu:
          cores: 2
          sockets: 1
          threads: 1
        memory:
          guest: 4Gi
        
        # Devices configuration
        devices:
          # Disk configuration
          disks:
          - name: rootdisk
            bootOrder: 1
            disk:
              bus: virtio
          - name: cloudinitdisk
            disk:
              bus: virtio
          
          # Network configuration
          interfaces:
          - name: default
            masquerade: {}
            
          # Enable serial console for troubleshooting
          rng: {}
        
        # Resource requirements
        resources:
          requests:
            memory: 4Gi
            cpu: "1"
          limits:
            memory: 4Gi
            cpu: "2"
            
        # Machine type for Fedora
        machine:
          type: pc-q35-rhel8.4.0
          
      # Ensure VM gets scheduled
      nodeSelector: {}
      
      # Network configuration
      networks:
      - name: default
        pod: {}
        
      # Volume configuration
      volumes:
      - name: rootdisk
        dataVolume:
          name: rhel8-legacy-validator
      - name: cloudinitdisk
        cloudInitNoCloud:
          secretRef:
            name: legacy-validator-cloud-init
            
  # Data volume templates (this ensures the DataVolume is created with the VM)
  dataVolumeTemplates:
  - metadata:
      name: rhel8-legacy-validator
      labels:
        app: legacy-validator
        component: vm
    spec:
      source:
        http:
          # Use Fedora 34 cloud image (simple, stable, RHEL8-like)
          url: "https://download.fedoraproject.org/pub/fedora/linux/releases/34/Cloud/x86_64/images/Fedora-Cloud-Base-34-1.2.x86_64.qcow2"
      storage:
        resources:
          requests:
            storage: 40Gi
        accessModes:
          - ReadWriteOnce
        storageClassName: nfs-nvme